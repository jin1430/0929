{{>layout/header}}
<style>
    /* ì•ˆë‚´ íŒ¨ë„ì„ ìœ„í•œ ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼ */
    .cg-notice-panel {
        margin: 24px 0 0 0;
        padding: 16px 20px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background-color: #f8fafc;
    }
    .cg-notice-panel strong {
        font-size: 16px;
    }
    .cg-notice-panel p {
        margin: 4px 0 0 0;
        font-size: 14px;
        color: #64748b;
    }
    /* ê±°ì ˆ ìƒíƒœì¼ ë•Œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
    .cg-notice-panel.is-danger {
        border-color: #fecaca;
        background-color: #fef2f2;
        color: #991b1b;
    }
    .cg-notice-panel.is-danger p {
        color: #b91c1c;
    }
</style>

<main class="cg-container" {{#cafe}}data-cafe-id="{{id}}"{{/cafe}}>

    {{#cafe}}
        {{#isPending}}
            <div class="cg-notice-panel">
                <strong>â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì¹´í˜ì…ë‹ˆë‹¤.</strong>
                <p>ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ìì˜ ìŠ¹ì¸ í›„ ì‚¬ì´íŠ¸ì— ì •ì‹ìœ¼ë¡œ ë…¸ì¶œë©ë‹ˆë‹¤. ìŠ¹ì¸ê¹Œì§€ëŠ” 1~2 ì˜ì—…ì¼ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        {{/isPending}}
        {{#isRejected}}
            <div class="cg-notice-panel is-danger">
                <strong>ğŸš« ë°˜ë ¤ëœ ì¹´í˜ ë“±ë¡ ìš”ì²­ì…ë‹ˆë‹¤.</strong>
                <p>ì´ í˜ì´ì§€ëŠ” ì™¸ë¶€ì— ë…¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë“±ë¡ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>
            </div>
        {{/isRejected}}
    {{/cafe}}
    <!-- ===== Hero (ì¢Œ: ë©”ì¸ ì‚¬ì§„ / ìš°: ì •ë³´) ===== -->
    <section class="cg-hero">
        {{#cafe}}
            <div class="cg-hero__inner">
                <!-- ì¢Œì¸¡: ë©”ì¸ ì‚¬ì§„ -->
                <div class="cg-hero__left">
                    <div class="cg-hero__imgwrap">
                        {{#mainPhoto}}
                            <img class="cg-card__img" src="{{url}}" alt="{{cafe.name}}"
                                 onerror="this.style.display='none'; this.parentElement.classList.add('cg-noimg');">
                        {{/mainPhoto}}
                        {{^mainPhoto}}
                            <img class="cg-card__img" src="/images/placeholder-cafe.jpg" alt="ì´ë¯¸ì§€ ì—†ìŒ"
                                 onerror="this.style.display='none'; this.parentElement.classList.add('cg-noimg');">
                        {{/mainPhoto}}
                    </div>
                </div>

                <!-- ìš°ì¸¡: ì œëª©/ë©”íƒ€/ì •ë³´/íƒœê·¸/ë²„íŠ¼ -->
                <div class="cg-hero__right">
                    <h1 class="cg-title" style="margin:0 0 8px 0">{{name}}</h1>

                    <div class="cg-hero__meta" style="margin-bottom:12px;display:flex;gap:8px;color:#64748b">
                        {{#views}}<span>ì¡°íšŒìˆ˜ {{views}}</span>{{/views}}{{^views}}<span>ì¡°íšŒìˆ˜ 0</span>{{/views}}
                        <span class="cg-dot">Â·</span>
                        {{#dateFmt}}<span>ë“±ë¡ {{dateFmt}}</span>{{/dateFmt}}{{^dateFmt}}<span>ë“±ë¡ {{date}}</span>{{/dateFmt}}
                        <span class="cg-dot">Â·</span>
                        <span>ì¢‹ì•„ìš” {{cafeGood}} / ì•„ì‰¬ì›Œìš” {{cafeBad}}</span>
                    </div>

                    <div class="cg-info-plain">
                        <dl class="cg-dl">
                            <div class="cg-dl__row"><dt>ì£¼ì†Œ</dt><dd>{{address}}</dd></div>
                            <div class="cg-dl__row"><dt>ì „í™”ë²ˆí˜¸</dt><dd>{{number}}</dd></div>
                        </dl>
                    </div>

                    <!-- íƒœê·¸ ì¹© -->
                    <div class="cg-chips" style="display:flex;flex-wrap:wrap;gap:8px;margin:12px 0">
                        {{#cafeTags}}
                            <button class="cg-chip" data-category="{{cafe.code}}" data-tag="{{code}}">
                                {{code}}{{#count}}<small class="cg-badge">{{count}}</small>{{/count}}
                            </button>
                        {{/cafeTags}}
                        {{^cafeTags}}<span class="cg-empty">ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ì–´ìš”.</span>{{/cafeTags}}
                    </div>

                    <!-- ì£¼ìš” ì•¡ì…˜ -->
                    <div class="cg-actions" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
                        <a class="cg-btn-outline" href="tel:{{number}}">ì „í™”í•˜ê¸°</a>
                        <a class="cg-btn-outline" target="_blank"
                           href="https://map.kakao.com/link/to/{{name}},{{lat}},{{lon}}">ê¸¸ì°¾ê¸°</a>
                        <a class="cg-btn"
                           href="#"
                           data-review-modal
                           data-cafe-id="{{id}}">ë¦¬ë·° ì‘ì„±</a>

                        <button type="button" id="favBtn"
                                class="cg-btn-outline"
                                data-cafe-id="{{id}}"
                                data-favorited="{{isFavorited}}">
                            {{#isFavorited}}ì¦ê²¨ì°¾ê¸° í•´ì œ{{/isFavorited}}{{^isFavorited}}ì¦ê²¨ì°¾ê¸°{{/isFavorited}}
                        </button>
                        {{#isOwner}}
                            <button class="cg-btn-outline" type="button" id="ownerEditToggle">ì ì£¼ í¸ì§‘</button>
                        {{/isOwner}}

                        <span id="favCount" style="margin-left:6px">
  {{#favoriteCount}}ì¦ê²¨ì°¾ê¸° {{favoriteCount}}{{/favoriteCount}}{{^favoriteCount}}ì¦ê²¨ì°¾ê¸° 0{{/favoriteCount}}
</span>
                        {{#isOwner}}
                            <a class="cg-btn-outline" href="/cafes/{{id}}/edit">ì •ë³´ ìˆ˜ì •</a>
                            <form method="post" action="/cafes/{{id}}/delete" style="display:inline">
                                {{#_csrf}}<input type="hidden" name="{{parameterName}}" value="{{token}}">{{/_csrf}}
                                <button class="cg-btn-outline" type="submit" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ì–´ìš”?')">ì‚­ì œ</button>
                            </form>
                        {{/isOwner}}
                    </div>
                </div>
            </div>
        {{/cafe}}
    </section>

    <!-- ===== ì˜ì—… ì •ë³´ / ì†Œê°œ ===== -->
    <section class="cg-section">
        <div class="cg-section__head"><h3>ì˜ì—… ì •ë³´</h3></div>
        <div class="cg-grid2">
            <div class="cg-card"><div class="cg-card__body">
                {{#info}}
                    <dl class="cg-dl">
                        <div class="cg-dl__row"><dt>ì˜¤í”ˆ</dt><dd>{{cafeOpenTime}}</dd></div>
                        <div class="cg-dl__row"><dt>ë§ˆê°</dt><dd>{{cafeCloseTime}}</dd></div>
                        <div class="cg-dl__row"><dt>íœ´ë¬´ì¼</dt><dd>{{cafeHoliday}}</dd></div>
                    </dl>
                {{/info}}
                {{^info}}<div class="cg-empty">ì˜ì—… ì •ë³´ê°€ ì•„ì§ ì—†ì–´ìš”.</div>{{/info}}
            </div></div>

            <div class="cg-card"><div class="cg-card__body">
                {{#info}}
                    {{#cafeNotice}}<div class="cg-note"><strong>ê³µì§€</strong> {{cafeNotice}}</div>{{/cafeNotice}}
                    {{#cafeInfo}}<p class="cg-desc">{{cafeInfo}}</p>{{/cafeInfo}}
                    {{^cafeNotice}}{{^cafeInfo}}<div class="cg-empty">ì†Œê°œ/ê³µì§€ ì •ë³´ê°€ ì•„ì§ ì—†ì–´ìš”.</div>{{/cafeInfo}}{{/cafeNotice}}
                {{/info}}
                {{^info}}<div class="cg-empty">ì†Œê°œ/ê³µì§€ ì •ë³´ê°€ ì•„ì§ ì—†ì–´ìš”.</div>{{/info}}
            </div></div>
        </div>
    </section>

    <!-- ===== ìœ„ì¹˜(ì§€ë„) ===== -->
    <section class="cg-section">
        <div class="cg-section__head"><h3>ìœ„ì¹˜</h3></div>
        <div class="cg-card"><div class="cg-card__body">
            {{#cafe}}
                <div id="map" class="cg-map" data-lat="{{lat}}" data-lon="{{lon}}" data-name="{{name}}">
                    <div class="cg-empty">ì§€ë„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            {{/cafe}}
        </div></div>
    </section>

    <!-- ===== ë©”ë‰´ ===== -->
        <style>
            .cg-menu-list{display:grid;gap:12px}
            .cg-menu-item{display:grid;grid-template-columns:1fr 120px;align-items:center;
                          padding:12px 16px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
            .cg-menu-thumb img{width:120px;height:120px;object-fit:cover;border-radius:12px}
            .cg-menu-name{font-weight:700;font-size:18px;margin-bottom:6px}
            .cg-menu-price{color:#334155}
        </style>

        <section class="cg-section">
            <div class="cg-section__head">
                <h3>ë©”ë‰´</h3>
                {{#cafe}}<a class="cg-link" href="/cafes/{{id}}/menu">ì „ì²´ ë©”ë‰´</a>{{/cafe}}
            </div>

            <ul class="cg-menu-list">
                {{#menus}}
                    <li class="cg-menu-item">
                        <div>
                            <div class="cg-menu-name">{{menuName}}</div>
                            <div class="cg-menu-price">{{menuPrice}}</div>
                        </div>
                        <div class="cg-menu-thumb">
                            <img src="{{menuPhoto}}" alt="{{menuName}}"
                                 onerror="this.onerror=null; this.src='/images/placeholder-cafe.jpg';">
                        </div>
                    </li>
                {{/menus}}
                {{^menus}}<li class="cg-empty">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ì–´ìš”.</li>{{/menus}}
            </ul>
        </section>
    </section>

    <!-- ===== ë°©ë¬¸ì ë¦¬ë·° ===== -->
    <section class="cg-section">
        <div class="cg-section__head"><h3>ë°©ë¬¸ì ë¦¬ë·°</h3></div>
        <ul class="cg-feed">
            {{#reviews}}
                <li class="cg-feed__item">
                    <p class="cg-feed__text">{{content}}</p>

                    <div class="cg-feed__photos" data-review-photos>
                        {{#photos}}
                            <img class="cg-feed__photo" src="{{photoUrl}}" alt="ë¦¬ë·° ì‚¬ì§„" loading="lazy"
                                 onerror="this.style.display='none'"/>
                        {{/photos}}
                        <span class="cg-feed__photo-count" hidden></span>
                    </div>

                    <div class="cg-feed__meta">
                        <span>{{createdAtFmt}}</span>
                        <span>ì¢‹ì•„ìš” {{good}} / ì•„ì‰¬ì›Œìš” {{bad}}</span>
                        {{#memberNickname}}<span class="cg-dot">Â·</span><span>{{memberNickname}}</span>{{/memberNickname}}
                    </div>
                </li>
            {{/reviews}}
            {{^reviews}}<li class="cg-empty">ì•„ì§ ë¦¬ë·°ê°€ ì—†ë„¤ìš”.</li>{{/reviews}}
        </ul>
    </section>


    <!-- ===== ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ (ì˜µì…˜: ëª¨ë¸ì— cafePhotos ìˆì„ ë•Œ) ===== -->
    <section class="cg-section">
        <div class="cg-section__head"><h3>ì‚¬ì§„</h3></div>
        <ul class="cg-card-grid">
            {{#cafePhotos}}
                <li class="cg-card">
                    <div class="cg-card__imgwrap">
                        <img class="cg-card__img" src="{{cafePhotoUrl}}" alt="{{#cafe}}{{name}}{{/cafe}}"
                             onerror="this.style.display='none'; this.parentElement.classList.add('cg-noimg');" />
                    </div>
                </li>
            {{/cafePhotos}}
            {{^cafePhotos}}<li class="cg-empty">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ì–´ìš”.</li>{{/cafePhotos}}
        </ul>
    </section>

</main>

<!-- ===========================
     ëª¨ë‹¬ (ë¦¬ë·° ì‘ì„±) â€“ ê¸°ì¡´ ìœ ì§€
     =========================== -->
<style>
    /* ëª¨ë‹¬: ê¸°ë³¸ ìˆ¨ê¹€, is-open ë•Œë§Œ í‘œì‹œ */
    .cg-modal{position:fixed;inset:0;display:none;z-index:1000}
    .cg-modal.is-open{display:grid}
    .cg-modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .cg-modal__dialog{position:relative;width:100%;height:100%;display:grid;place-items:center;padding:20px;pointer-events:none}
    .cg-modal__sheet{width:min(720px,96vw);max-height:88vh;background:#fff;border-radius:16px;overflow:auto;pointer-events:auto}
    .cg-modal__header,.cg-modal__footer{padding:16px 20px}
    .cg-modal__content{padding:0 20px 16px}
    .cg-modal__title{margin:0;font-size:20px}
    .cg-modal__close{border:0;background:transparent;font-size:28px;line-height:1;cursor:pointer;margin-left:auto}
    body.cg-modal-open{overflow:hidden}
</style>

<div id="reviewModal" class="cg-modal" aria-hidden="true" role="dialog" aria-labelledby="reviewModalTitle">
    <div class="cg-modal__backdrop" data-close-modal></div>
    <div class="cg-modal__dialog">
        <form id="reviewForm" class="cg-modal__sheet" method="post" action="/reviews/new" enctype="multipart/form-data" novalidate>
            {{#_csrf}}<input type="hidden" name="{{parameterName}}" value="{{token}}">{{/_csrf}}
            <input type="hidden" name="cafeId" id="modalCafeId"/>

            <div class="cg-modal__header" style="display:flex;gap:8px;align-items:center">
                <h3 id="reviewModalTitle" class="cg-modal__title">ë¦¬ë·° ì‘ì„±</h3>
                <button type="button" class="cg-modal__close" aria-label="ë‹«ê¸°" data-close-modal>&times;</button>
            </div>

            <div class="cg-modal__content">
                <label class="cg-label">ë‚´ìš©</label>
                <textarea name="reviewContent" class="cg-input" rows="8" style="min-height:160px" placeholder="ë°©ë¬¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." required maxlength="1000" autofocus aria-required="true"></textarea>

                <label class="cg-label" style="margin-top:12px">ì „ë°˜ì  ë§Œì¡±ë„</label>
                <div class="cg-toggle2" role="group" aria-label="ì „ë°˜ì  ë§Œì¡±ë„">
                    <label class="cg-toggle2__btn">
                        <input type="radio" name="sentiment" value="GOOD" checked>
                        <span>ì¢‹ì•„ìš”</span>
                    </label>
                    <label class="cg-toggle2__btn">
                        <input type="radio" name="sentiment" value="BAD">
                        <span>ì•„ì‰¬ì›Œìš”</span>
                    </label>
                </div>

                <label class="cg-label" style="margin-top:12px">ì´ëŸ° ì ì´ ì¢‹ì•˜ì–´ìš” (ë³µìˆ˜ì„ íƒ)</label>
                <div class="cg-chips">
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ë§›ìˆì–´ìš”"> ìŒì‹ì´ ë§›ìˆì–´ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ì¹œì ˆí•´ìš”"> ì¹œì ˆí•´ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ì¸í…Œë¦¬ì–´"> ì¸í…Œë¦¬ì–´ê°€ ë©‹ì ¸ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ì‹ ì„ í•œì¬ë£Œ"> ì¬ë£Œê°€ ì‹ ì„ í•´ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="íŠ¹ë³„í•œë©”ë‰´"> íŠ¹ë³„í•œ ë©”ë‰´ê°€ ìˆì–´ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ê¸°ë³¸ì•ˆì£¼"> ê¸°ë³¸ ì•ˆì£¼ê°€ ì¢‹ì•„ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ìŒì•…"> ìŒì•…ì´ ì¢‹ì•„ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="í˜¼ìˆ "> í˜¼ìˆ í•˜ê¸° ì¢‹ì•„ìš”</label>
                    <label class="cg-chip"><input type="checkbox" name="likedTagCodes" value="ê°€ì„±ë¹„"> ê°€ì„±ë¹„ê°€ ì¢‹ì•„ìš”</label>
                </div>

                <label class="cg-label" style="margin-top:12px">ì‚¬ì§„ (ì„ íƒ)</label>
                <input id="photoInput" class="cg-sr-only" type="file" name="photos" accept="image/*" multiple>
                <label for="photoInput" class="cg-btn-outline">íŒŒì¼ ì„ íƒ</label>
                <small class="cg-help">ìµœëŒ€ 5ì¥, ì´ë¯¸ì§€ë‹¹ 10MB ì´í•˜ ê¶Œì¥</small>
            </div>

            <div class="cg-modal__footer" style="display:flex;justify-content:flex-end;gap:8px">
                <button type="button" class="cg-btn-outline" data-close-modal>ì·¨ì†Œ</button>
                <button type="submit" class="cg-btn">ë“±ë¡</button>
            </div>
        </form>
    </div>
</div>
<!-- ===== ì ì£¼ í¸ì§‘ ëª¨ë‹¬ ===== -->
<div id="ownerModal" class="cg-modal" aria-hidden="true" role="dialog" aria-labelledby="ownerModalTitle">
    <div class="cg-modal__backdrop" data-close-modal></div>
    <div class="cg-modal__dialog">
        <div class="cg-modal__sheet">
            <div class="cg-modal__header" style="display:flex;gap:8px;align-items:center">
                <h3 id="ownerModalTitle" class="cg-modal__title">ì ì£¼ í¸ì§‘</h3>
                <button type="button" class="cg-modal__close" aria-label="ë‹«ê¸°" data-close-modal>&times;</button>
            </div>

            <div class="cg-modal__content">
                <!-- A. ì¹´í˜ ì†Œê°œ/ê³µì§€/ì˜ì—…ì •ë³´ -->
                <div class="cg-card" style="margin:0 0 16px 0">
                    <div class="cg-card__head"><h4>ì¹´í˜ ì†Œê°œ/ê³µì§€ Â· ì˜ì—…ì •ë³´</h4></div>
                    <div class="cg-card__body">
                        <form id="cafeInfoFormModal" class="space-y">
                            <input type="hidden" name="id" id="cafeInfoIdModal">
                            <div class="cg-grid3">
                                <label class="field"><div class="field__label">ì˜¤í”ˆ</div><input class="cg-input" name="openTime" placeholder="09:00"></label>
                                <label class="field"><div class="field__label">ë§ˆê°</div><input class="cg-input" name="closeTime" placeholder="21:00"></label>
                                <label class="field"><div class="field__label">íœ´ë¬´ì¼</div><input class="cg-input" name="holiday" placeholder="ì›”"></label>
                            </div>
                            <label class="field"><div class="field__label">ê³µì§€</div><input class="cg-input" name="notice" maxlength="20"></label>
                            <label class="field"><div class="field__label">ì†Œê°œ</div><textarea class="cg-input" name="info" rows="4" maxlength="500"></textarea></label>
                            <div class="cg-actions end" style="gap:8px">
                                <button type="button" class="cg-btn" id="cafeInfoSaveBtnModal">ì €ì¥</button>
                                <button type="button" class="cg-btn-outline" id="cafeInfoDeleteBtnModal">ì‚­ì œ</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- B. ì‚¬ì§„ ê´€ë¦¬ -->
                <div class="cg-card">
                    <div class="cg-card__head"><h4>ì‚¬ì§„ ê´€ë¦¬</h4></div>
                    <div class="cg-card__body">
                        <form id="photoUploadFormModal" class="space-y" enctype="multipart/form-data">
                            <input class="cg-input" type="file" name="files" accept="image/*" multiple required>
                            <div class="cg-actions end"><button type="submit" class="cg-btn">ì—…ë¡œë“œ</button></div>
                        </form>
                        <ul id="cafePhotoListModal" class="cg-feed" style="margin-top:12px"></ul>
                    </div>
                </div>
                <!-- C. ë©”ë‰´ ê´€ë¦¬ -->
                <div class="cg-card" style="margin-top:16px">
                    <div class="cg-card__head"><h4>ë©”ë‰´ ê´€ë¦¬</h4></div>
                    <div class="cg-card__body">
                        <!-- ìƒˆ ë©”ë‰´ ì¶”ê°€ -->
                        <form id="menuCreateFormModal" class="space-y">
                            <div class="cg-grid2">
                                <input class="cg-input" name="name" placeholder="ë©”ë‰´ëª…" required maxlength="30">
                                <input class="cg-input" type="number" name="price" placeholder="ê°€ê²©(ì›)" min="0" step="100" required>
                            </div>
                            <div class="cg-grid2">
                                <label class="cg-checkbox"><input type="checkbox" name="isNew">ì‹ ê·œ</label>
                                <label class="cg-checkbox"><input type="checkbox" name="isRecommended">ì¶”ì²œ</label>
                            </div>
                            <!-- (ì„ íƒ) ë©”ë‰´ ì‚¬ì§„ ì—…ë¡œë“œ -->
                            <input class="cg-input" type="file" name="menuPhoto" accept="image/*">
                            <div class="cg-actions end"><button type="submit" class="cg-btn">ë©”ë‰´ ì¶”ê°€</button></div>
                        </form>

                        <hr style="margin:16px 0">
                        <!-- ë©”ë‰´ ëª©ë¡/ìˆ˜ì •/ì‚­ì œ -->
                        <ul id="ownerMenuListModal" class="cg-feed"></ul>
                    </div>
                </div>
            </div>


            <div class="cg-modal__footer" style="display:flex;justify-content:flex-end;gap:8px">
                <button type="button" class="cg-btn" id="ownerSaveAllBtn">ì €ì¥</button>
                <button type="button" class="cg-btn-outline" data-close-modal>ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
      // --- JWT ---
      const AUTH = (() => {
        function token(){ return localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken') || ''; }
        function withJwt(init){ init=init||{}; const t=token();
          init.headers = Object.assign({ 'Accept':'application/json' }, init.headers||{}, t?{ 'Authorization':'Bearer '+t }:{} );
          init.credentials='same-origin'; return init; }
        return { withJwt };
      })();

      const cafeId = document.querySelector('main.cg-container')?.dataset.cafeId || "{{#cafe}}{{id}}{{/cafe}}";

  // --- ëª¨ë‹¬ ì—´ê³  ë‹«ê¸° ---
  const ownerBtn   = document.getElementById('ownerEditToggle');
  const ownerModal = document.getElementById('ownerModal');
  ownerBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });

  function openModal(){
    ownerModal.classList.add('is-open'); document.body.classList.add('cg-modal-open');
    loadCafeInfo(); loadPhotos(); loadMenus();
  }
  function closeModal(){
    ownerModal.classList.remove('is-open'); document.body.classList.remove('cg-modal-open');
  }
  ownerModal?.querySelectorAll('[data-close-modal]').forEach(el=>el.addEventListener('click', closeModal));
  ownerModal?.addEventListener('click', e=>{ if(e.target.classList.contains('cg-modal__backdrop')) closeModal(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && ownerModal?.classList.contains('is-open')) closeModal(); });

  // --- A. CafeInfo ---
  async function fetchCafeInfo(){
    const r = await fetch(`/api/cafe-infos/by-cafe/${cafeId}`, AUTH.withJwt());
    if (r.status === 404) return null; return r.json();
  }
  async function loadCafeInfo(){
    const f = document.getElementById('cafeInfoFormModal');
    const data = await fetchCafeInfo();
    document.getElementById('cafeInfoIdModal').value = data?.id || '';
    f.openTime.value  = data?.openTime  || '';
    f.closeTime.value = data?.closeTime || '';
    f.holiday.value   = data?.holiday   || '';
    f.notice.value    = data?.notice    || '';
    f.info.value      = data?.info      || '';
  }

  async function saveCafeInfo(){
    const f = document.getElementById('cafeInfoFormModal');
    const payload = {
      cafe: { id: Number(cafeId) },
      openTime: f.openTime.value, closeTime: f.closeTime.value,
      holiday: f.holiday.value,   notice: f.notice.value, info: f.info.value
    };
    const id = document.getElementById('cafeInfoIdModal').value;
    const url = id ? `/api/cafe-infos/${id}` : `/api/cafe-infos/upsert/${cafeId}`;
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, AUTH.withJwt({ method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }));
    return res.ok;
  }

  document.getElementById('ownerSaveAllBtn')?.addEventListener('click', async ()=>{
    const ok = await saveCafeInfo();
    if (ok) { alert('ì €ì¥í–ˆìŠµë‹ˆë‹¤.'); location.reload(); } else { alert('ì €ì¥ ì‹¤íŒ¨'); }
  });

  // --- B. Photos ---
  async function fetchPhotos(){ const r = await fetch(`/api/cafes/${cafeId}/photos`, AUTH.withJwt()); return r.json(); }
  function photoItemTpl(p){ return `
    <li class="cg-feed__item" data-id="${p.id}">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${p.url}" style="width:96px;height:96px;object-fit:cover;border-radius:8px">
        <div style="flex:1">
          <div style="font-weight:600">${p.originalName||'ì‚¬ì§„'}</div>
          ${p.main ? '<span class="cg-badge">ëŒ€í‘œ</span>' : ''}
        </div>
        <div style="display:flex;gap:6px">
          ${p.main ? '' : '<button type="button" class="cg-btn-outline" data-act="main">ëŒ€í‘œì„¤ì •</button>'}
          <button type="button" class="cg-btn-outline" data-act="del">ì‚­ì œ</button>
        </div>
      </div>
    </li>`; }
  async function loadPhotos(){
    const list = document.getElementById('cafePhotoListModal'); if (!list) return;
    const items = await fetchPhotos(); list.innerHTML = items.map(photoItemTpl).join('');
    list.querySelectorAll('button[data-act]').forEach(btn=>{
      const id = btn.closest('[data-id]').dataset.id;
      if (btn.dataset.act==='del'){
        btn.addEventListener('click', async ()=>{
          if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
          const r = await fetch(`/api/cafes/photos/${id}`, AUTH.withJwt({ method:'DELETE' }));
          if (r.ok) loadPhotos(); else alert('ì‚­ì œ ì‹¤íŒ¨');
        });
      }else if(btn.dataset.act==='main'){
        btn.addEventListener('click', async ()=>{
          const r = await fetch(`/api/cafes/photos/${id}/main`, AUTH.withJwt({ method:'PATCH' }));
          if (r.ok) loadPhotos(); else alert('ë³€ê²½ ì‹¤íŒ¨');
        });
      }
    });
  }
  document.getElementById('photoUploadFormModal')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const r = await fetch(`/api/cafes/${cafeId}/photos`, AUTH.withJwt({ method:'POST', body: fd }));
    if (r.ok){ e.currentTarget.reset(); loadPhotos(); } else alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
  });

  // --- C. Menus ---
  async function fetchMenus(){ const r = await fetch(`/api/menus/by-cafe/${cafeId}`, AUTH.withJwt()); return r.json(); }
  function menuItemTpl(m){ return `
    <li class="cg-feed__item" data-id="${m.id}">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${m.photo}" style="width:64px;height:64px;object-fit:cover;border-radius:8px"
            onerror="this.style.display='none'">
        <div style="flex:1">
          <div style="font-weight:600">${m.name} <small>${m.price}ì›</small></div>
          <div class="muted">${m.isNew?'New':''} ${m.isRecommended?'Â· ì¶”ì²œ':''}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button type="button" class="cg-btn-outline" data-act="edit">ìˆ˜ì •</button>
          <button type="button" class="cg-btn-outline" data-act="del">ì‚­ì œ</button>
          <button type="button" class="cg-btn-outline" data-act="photo">ì‚¬ì§„</button>
        </div>
      </div>
    </li>`; }
  async function loadMenus(){
    const list = document.getElementById('ownerMenuListModal'); if (!list) return;
    const items = await fetchMenus(); list.innerHTML = items.map(menuItemTpl).join('');
    list.querySelectorAll('button[data-act]').forEach(btn=>{
      const id = btn.closest('[data-id]').dataset.id;
      if (btn.dataset.act==='del'){
        btn.addEventListener('click', async ()=>{
          if(!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
          const r = await fetch('/api/menus/'+id, AUTH.withJwt({ method:'DELETE' }));
          if (r.ok) loadMenus(); else alert('ì‚­ì œ ì‹¤íŒ¨');
        });
      } else if (btn.dataset.act==='edit'){
        btn.addEventListener('click', async ()=>{
          const name = prompt('ë©”ë‰´ëª…?'); if (name===null) return;
          const price = Number(prompt('ê°€ê²©(ì›)?')); if (Number.isNaN(price)) return alert('ê°€ê²©ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.');
          const isNew = confirm('ì‹ ê·œë¡œ í‘œì‹œí• ê¹Œìš”?');
          const isRecommended = confirm('ì¶”ì²œìœ¼ë¡œ í‘œì‹œí• ê¹Œìš”?');
          const payload = { name, price, isNew, isRecommended };
          const r = await fetch('/api/menus/'+id, AUTH.withJwt({ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }));
          if (r.ok) loadMenus(); else alert('ìˆ˜ì • ì‹¤íŒ¨');
        });
      } else if (btn.dataset.act==='photo'){
        btn.addEventListener('click', async ()=>{
          const input = document.createElement('input'); input.type='file'; input.accept='image/*';
          input.onchange = async ()=>{
            const fd = new FormData(); fd.append('file', input.files[0]);
            const r = await fetch('/api/menus/'+id+'/photo', AUTH.withJwt({ method:'POST', body: fd }));
            if (r.ok) loadMenus(); else alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
          };
          input.click();
        });
      }
    });
  }
  document.getElementById('menuCreateFormModal')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = e.currentTarget;

     if (!f.menuPhoto.files[0]) {
   alert('ë©”ë‰´ ì‚¬ì§„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
   return;
        }

    const fd = new FormData();
    fd.append('cafeId', Number(cafeId));
    fd.append('name', f.name.value.trim());
    fd.append('price', Number(f.price.value));
    fd.append('isNew', f.isNew.checked);
    fd.append('isRecommended', f.isRecommended.checked);
    fd.append('file', f.menuPhoto.files[0]);

     const r = await fetch('/api/menus', AUTH.withJwt({ method:'POST', body: fd }));
     if (!r.ok) { alert('ë“±ë¡ ì‹¤íŒ¨'); return; }

    f.reset(); loadMenus();
  });

})();
</script>




{{>layout/footer}}