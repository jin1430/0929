{{>layout/header}}

<main class="cg-container mypage" style="padding:24px 0">
    <h1 class="cg-title">내 정보 수정</h1>

    <div class="cg-mypage-grid" id="me-layout">
        <aside>
            <nav class="cg-sidenav">
                <a href="/member/me">내 정보</a>
                <a href="/member/edit" class="is-active">내 정보 수정</a>
                <a href="/reviews/mine">내가 쓴 리뷰</a>
                <a href="/favorites">즐겨찾기 목록 확인</a>
                <a href="/member/withdraw" class="is-danger">회원 탈퇴</a>
            </nav>
        </aside>

        <section>
            {{#member}}
                <form id="editForm" method="post" action="/member/edit" class="cg-form" autocomplete="off">
                    <!-- CSRF 제거: JWT 헤더 사용 시 불필요 -->

                    <!-- 기본 정보 -->
                    <div class="cg-card" style="margin-bottom:16px;">
                        <div class="cg-card__head"><h2 style="font-size:18px;margin:0;">기본 정보</h2></div>
                        <div class="cg-card__body">
                            <div style="display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap;">
                                <div style="flex:1;min-width:260px;">
                                    <label for="member_nickname">닉네임</label>
                                    <input id="member_nickname" name="member_nickname" value="{{nickname}}" maxlength="8" required>

                                    <label for="member_age" style="margin-top:12px;">나이</label>
                                    <input id="member_age" name="member_age" type="number" value="{{age}}" min="1" max="120">

                                    <label for="member_gender" style="margin-top:12px;">성별</label>
                                    <input id="member_gender" name="member_gender" maxlength="1" value="{{gender}}" placeholder="예: M / F">

                                    <label for="member_photo" style="margin-top:12px;">프로필 사진 파일명</label>
                                    <input id="member_photo" name="member_photo" value="{{photoName}}" placeholder="예: avatar01.png">
                                </div>

                                <div style="width:160px;text-align:center;">
                                    {{#hasPhoto}}
                                        <img src="{{photoUrl}}" alt="현재 프로필" class="cg-avatar-lg">
                                        <div style="margin-top:8px;font-size:12px;color:#6b7280;">현재: {{photoName}}</div>
                                    {{/hasPhoto}}
                                    {{^hasPhoto}}
                                        <div class="cg-avatar-lg" style="background:#e5e7eb;display:flex;align-items:center;justify-content:center;margin:0 auto;">
                                            <span style="font-size:12px;color:#6b7280;">NO IMG</span>
                                        </div>
                                        <div style="margin-top:8px;font-size:12px;color:#6b7280;">현재: 없음</div>
                                    {{/hasPhoto}}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 비밀번호 변경(선택) -->
                    <div class="cg-card" style="margin-bottom:16px;">
                        <div class="cg-card__head"><h2 style="font-size:18px;margin:0;">비밀번호 변경 (선택)</h2></div>
                        <div class="cg-card__body">
                            <label for="current_password">현재 비밀번호</label>
                            <input id="current_password" name="current_password" type="password" autocomplete="current-password" placeholder="변경 시에만 입력">

                            <label for="new_password" style="margin-top:12px;">새 비밀번호</label>
                            <input id="new_password" name="new_password" type="password" autocomplete="new-password" placeholder="변경 시에만 입력">
                            <p style="margin-top:8px;font-size:12px;color:#6b7280;">* 현재/새 비밀번호를 모두 입력한 경우에만 비밀번호가 변경됩니다.</p>
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button type="submit" class="cg-btn">저장</button>
                        <a href="/member/me" class="cg-btn-ghost">취소</a>
                    </div>
                </form>
            {{/member}}

            {{^member}}
                <div class="cg-card"><div class="cg-card__body">사용자 정보를 불러오지 못했습니다.</div></div>
            {{/member}}
        </section>
    </div>
</main>

<script>
    (function(){
      const form = document.getElementById('editForm');
      if(!form) return;
      const token = localStorage.getItem('accessToken'); // 저장 키 이름 맞게 조정

      // 토큰이 있으면 AJAX로 전송(헤더 포함), 없으면 기본 제출
      if(token){
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(form).entries());
          const res = await fetch(form.action, {
            method: 'POST',           // 서버가 PUT/PATCH를 기대하면 바꿔주세요
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          if(res.ok){
            window.location.href = '/member/me';
          }else{
            const t = await res.text();
            alert('저장 실패\n' + t);
          }
        });
      }
    })();
</script>

{{>layout/footer}}
