{{> layout/header}}
<link rel="stylesheet" href="/css/admin.css">

<main class="cg-container" style="padding:24px 0">
    <h1 class="admin-h1">관리자 대시보드</h1>

    <!-- 통계 카드 -->
    <section class="grid" style="grid-template-columns:repeat(6,minmax(0,1fr));gap:16px;margin-bottom:24px">
        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <div class="text-3xl font-bold" style="color:#f59e0b">{{#pendingCafeCount}}{{.}}{{/pendingCafeCount}}{{^pendingCafeCount}}0{{/pendingCafeCount}}</div>
            <div class="text-gray-600">승인 대기 카페</div>
        </div>
        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <div class="text-3xl font-bold" style="color:#ef4444">{{#reportPendingCount}}{{.}}{{/reportPendingCount}}{{^reportPendingCount}}0{{/reportPendingCount}}</div>
            <div class="text-gray-600">대기중 신고</div>
        </div>

        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <div class="text-3xl font-bold" style="color:#10b981">{{#pendingMissionCount}}{{pendingMissionCount}}{{/pendingMissionCount}}{{^pendingMissionCount}}0{{/pendingMissionCount}}</div>
            <div class="text-gray-600"><a href="/admin/missions">승인 대기 미션</a></div>
        </div>

        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <div class="text-3xl font-bold" style="color:#14b8a6">{{#approvedCafeCount}}{{.}}{{/approvedCafeCount}}{{^approvedCafeCount}}0{{/approvedCafeCount}}</div>
            <div class="text-gray-600">총 카페 수</div>
        </div>
        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <div class="text-3xl font-bold" style="color:#3b82f6">{{#reviewTotalCount}}{{.}}{{/reviewTotalCount}}{{^reviewTotalCount}}0{{/reviewTotalCount}}</div>
            <div class="text-gray-600">총 리뷰 수</div>
        </div>
        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <div class="text-3xl font-bold" style="color:#a855f7">{{#activeUserCount}}{{.}}{{/activeUserCount}}{{^activeUserCount}}0{{/activeUserCount}}</div>
            <div class="text-gray-600">활성 사용자</div>
        </div>
    </section>

    <!-- 퀵 링크 (SSR 탭) -->
    <nav class="admin-quicklinks">
        <a href="/admin?tab=cafes"    class="{{#isTabCafes}}is-active{{/isTabCafes}}">카페 승인 관리</a>
        <a href="/admin?tab=missions" class="{{#isTabMissions}}is-active{{/isTabMissions}}">미션 리뷰 판정</a>
        <a href="/admin?tab=reports"  class="{{#isTabReports}}is-active{{/isTabReports}}">신고 관리</a>
        <a href="/admin?tab=members"  class="{{#isTabMembers}}is-active{{/isTabMembers}}">멤버 등업관리</a>
    </nav>

    <div class="cg-mypage-grid" id="admin-layout">
        <section style="display:flex;flex-direction:column;gap:24px">

            {{#isTabCafes}}
                <!-- 카페 관리 -->
                <article id="section-cafes" class="cg-panel">
                    <header class="cg-panel__head">
                        <div>
                            <div class="cg-eyebrow">카페 관리</div>
                            <h2 class="cg-panel__title">승인 대기 목록</h2>
                        </div>
                    </header>

                    <div class="cg-panel__body">
                        <table class="cg-table" style="width:100%">
                            <thead>
                            <tr>
                                <th style="width:80px">ID</th>
                                <th>이름</th>
                                <th>주소</th>
                                <th style="width:220px">액션</th>
                            </tr>
                            </thead>
                            <tbody>
                            {{#pendingCafes}}
                                <tr>
                                    <td>{{id}}</td>
                                    <td><a href="/cafes/{{id}}" target="_blank" rel="noopener">{{name}}</a></td>
                                    <td>{{address}}</td>
                                    <td style="display:flex;gap:8px">
                                        <a href="/admin/cafes/{{id}}/bizdoc" class="cg-btn-outline" {{^bizDoc}}style="display:none" aria-disabled="true"{{/bizDoc}}>증빙서</a>
                                        <button class="cg-btn" data-post="/admin/cafes/{{id}}/approve">승인</button>
                                        <button class="cg-btn-outline is-danger" data-post="/admin/cafes/{{id}}/reject">거절</button>
                                    </td>
                                </tr>
                            {{/pendingCafes}}
                            {{^pendingCafes}}
                                <tr><td colspan="4" class="table-empty">승인 대기 중인 카페가 없습니다.</td></tr>
                            {{/pendingCafes}}
                            </tbody>
                        </table>
                    </div>
                </article>
            {{/isTabCafes}}

            {{#isTabMissions}}
                <!-- 미션 리뷰 판정 -->
                <article class="cg-panel">
                    <header class="cg-panel__head">
                        <div>
                            <div class="cg-eyebrow">미션 관리</div>
                            <h2 class="cg-panel__title">완료된 미션 리뷰</h2>
                        </div>
                    </header>
                    <div class="cg-panel__body">
                        <table class="cg-table" style="width:100%">
                            <thead>
                            <tr>
                                <th style="width:90px">리뷰ID</th>
                                <th>회원</th>
                                <th>카페</th>
                                <th style="width:120px">현재평가</th>
                                <th style="width:260px">판정</th>
                                <th style="width:100px">보기</th>
                            </tr>
                            </thead>
                            <tbody>
                            {{#missionReviews}}
                                <tr>
                                    <td>{{reviewId}}</td>
                                    <td>{{memberNickname}}</td>
                                    <td>{{cafeName}}</td>
                                    <td>{{currentSentiment}}</td>
                                    <td style="display:flex;gap:8px">
                                        <button class="cg-btn" data-post="/admin/missions/{{reviewId}}/sentiment?v=GOOD">GOOD</button>
                                        <button class="cg-btn-outline" data-post="/admin/missions/{{reviewId}}/sentiment?v=BAD">BAD</button>
                                    </td>
                                    <td><a class="cg-btn-outline" href="/reviews/{{reviewId}}" target="_blank" rel="noopener">리뷰</a></td>
                                </tr>
                            {{/missionReviews}}
                            {{^missionReviews}}
                                <tr><td colspan="6" class="table-empty">완료된 미션 리뷰가 없습니다.</td></tr>
                            {{/missionReviews}}
                            </tbody>
                        </table>
                    </div>
                </article>
            {{/isTabMissions}}

            {{#isTabReports}}
                <!-- 신고 관리 -->
                <article class="cg-panel">
                    <header class="cg-panel__head">
                        <div>
                            <div class="cg-eyebrow">신고 관리</div>
                            <h2 class="cg-panel__title">신고 대기 목록</h2>
                        </div>
                    </header>
                    <div class="cg-panel__body">
                        <table class="cg-table" style="width:100%">
                            <thead>
                            <tr>
                                <th style="width:90px">신고ID</th>
                                <th>리뷰ID</th>
                                <th>사유</th>
                                <th style="width:220px">액션</th>
                            </tr>
                            </thead>
                            <tbody>
                            {{#pendingReports}}
                                <tr>
                                    <td>{{id}}</td>
                                    <td>{{reviewId}}</td>
                                    <td>{{reason}}</td>
                                    <td style="display:flex;gap:8px">
                                        <button class="cg-btn" data-post="/admin/reports/{{id}}/approve">승인</button>
                                        <button class="cg-btn-outline is-danger" data-post="/admin/reports/{{id}}/reject">거절</button>
                                    </td>
                                </tr>
                            {{/pendingReports}}
                            {{^pendingReports}}
                                <tr><td colspan="4" class="table-empty">대기중인 신고가 없습니다.</td></tr>
                            {{/pendingReports}}
                            </tbody>
                        </table>
                    </div>
                </article>
            {{/isTabReports}}

            {{#isTabMembers}}
                <!-- 멤버 등업관리 -->
                <article class="cg-panel">
                    <header class="cg-panel__head">
                        <div>
                            <div class="cg-eyebrow">멤버 관리</div>
                            <h2 class="cg-panel__title">등업 후보 / 등급 관리</h2>
                        </div>
                    </header>
                    <div class="cg-panel__body">
                        <table class="cg-table" style="width:100%">
                            <thead>
                            <tr>
                                <th style="width:90px">회원ID</th>
                                <th>닉네임</th>
                                <th>이메일</th>
                                <th style="width:120px">리뷰(총/GOOD)</th>
                                <th style="width:120px">현재등급</th>
                                <th style="width:260px">액션</th>
                            </tr>
                            </thead>
                            <tbody>
                            {{#proCandidates}}
                                <tr>
                                    <td>{{id}}</td>
                                    <td>{{nickname}}</td>
                                    <td>{{email}}</td>
                                    <td>{{totalReviews}} / {{goodReviews}}</td>
                                    <td>{{roleKind}}</td>
                                    <td style="display:flex;gap:8px">
                                        <button class="cg-btn" data-post="/admin/members/{{id}}/promote?to=PRO">PRO 승급</button>
                                        <button class="cg-btn-outline" data-post="/admin/members/{{id}}/demote?to=MEMBER">MEMBER 강등</button>
                                    </td>
                                </tr>
                            {{/proCandidates}}
                            {{^proCandidates}}
                                <tr><td colspan="6" class="table-empty">등업 후보가 없습니다.</td></tr>
                            {{/proCandidates}}
                            </tbody>
                        </table>
                    </div>
                </article>
            {{/isTabMembers}}

        </section>
    </div>
</main>

{{> layout/footer}}

<script>
    async function postWithJwt(url) {
      const headers = {};
      const token = localStorage.getItem('accessToken');
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(url, { method: 'POST', headers });
      if (!res.ok) throw new Error(res.status + ' ' + (await res.text()).slice(0,200));
      return res;
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-post]');
      if (!btn) return;
      e.preventDefault();
      btn.disabled = true;
      try {
        await postWithJwt(btn.dataset.post);
        location.reload();
      } catch (err) {
        alert('요청 실패: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    });
</script>
