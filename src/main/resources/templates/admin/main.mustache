{{> layout/header}}

<main class="cg-container" style="padding:24px 0">
    <h1 class="cg-title">관리자 페이지</h1>

    <div class="cg-mypage-grid" id="admin-layout">
        <aside>
            <nav class="cg-sidenav">
                <a href="/admin" class="is-active">대시보드</a>
                <a href="#section-cafes">카페 관리</a>
                <a href="#section-missions">미션 관리</a>
            </nav>
        </aside>

        <section style="display:flex;flex-direction:column;gap:24px">

            <article id="section-cafes" class="cg-panel">
                <header class="cg-panel__head">
                    <div>
                        <div class="cg-eyebrow">카페 관리</div>
                        <h2 class="cg-panel__title">승인 대기 목록</h2>
                    </div>
                </header>

                <div class="cg-panel__body">
                    <table class="cg-table" style="width:100%">
                        <thead>
                        <tr>
                            <th style="width:80px">ID</th>
                            <th>이름</th>
                            <th>주소</th>
                            <th style="width:220px">액션</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{#pendingCafes}}
                            <tr>
                                <td>{{id}}</td>
                                <td><a href="/cafes/{{id}}" target="_blank" rel="noopener">{{name}}</a></td>
                                <td>{{address}}</td>
                                <td style="display:flex;gap:8px">
                                    <a href="/admin/cafes/{{id}}/bizdoc"
                                       class="cg-btn-outline"
                                        {{^bizDoc}}style="display:none" aria-disabled="true"{{/bizDoc}}>
                                        증빙서
                                    </a>
                                    <button class="cg-btn" data-post="/admin/cafes/{{id}}/approve">승인</button>
                                    <button class="cg-btn-outline is-danger" data-post="/admin/cafes/{{id}}/reject">거절</button>
                                </td>
                            </tr>
                        {{/pendingCafes}}

                        {{^pendingCafes}}
                            <tr>
                                <td colspan="4" style="text-align:center;color:#64748b">
                                    승인 대기 중인 카페가 없습니다.
                                </td>
                            </tr>
                        {{/pendingCafes}}
                        </tbody>
                    </table>
                </div>
            </article>

            <article id="section-missions" class="cg-panel">
                <header class="cg-panel__head">
                    <div>
                        <div class="cg-eyebrow">미션 관리</div>
                        <h2 class="cg-panel__title">완료된 미션 리뷰</h2>
                    </div>
                </header>

                <div class="cg-panel__body">
                    <table class="cg-table" style="width:100%">
                        <thead>
                        <tr>
                            <th style="width:90px">리뷰ID</th>
                            <th>회원</th>
                            <th>카페</th>
                            <th style="width:120px">현재평가</th>
                            <th style="width:260px">판정</th>
                            <th style="width:100px">보기</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{#missionReviews}}
                            <tr>
                                <td>{{reviewId}}</td>
                                <td>{{memberNickname}}</td>
                                <td>{{cafeName}}</td>
                                <td>{{currentSentiment}}</td>
                                <td style="display:flex;gap:8px">
                                    <button class="cg-btn" data-post="/admin/missions/{{reviewId}}/sentiment?v=GOOD">GOOD</button>
                                    <button class="cg-btn-outline" data-post="/admin/missions/{{reviewId}}/sentiment?v=BAD">BAD</button>
                                </td>
                                <td>
                                    <a class="cg-btn-outline" href="/reviews/{{reviewId}}" target="_blank" rel="noopener">리뷰</a>
                                </td>
                            </tr>
                        {{/missionReviews}}

                        {{^missionReviews}}
                            <tr>
                                <td colspan="6" style="text-align:center;color:#64748b">
                                    완료된 미션 리뷰가 없습니다.
                                </td>
                            </tr>
                        {{/missionReviews}}
                        </tbody>
                    </table>
                </div>
            </article>

        </section>
    </div>
</main>

{{> layout/footer}}

<script>
    async function postWithJwt(url) {
      const headers = {};
      const token = localStorage.getItem('accessToken');
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(url, { method: 'POST', headers });
      if (!res.ok) throw new Error(res.status + ' ' + (await res.text()).slice(0,200));
      return res;
    }
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-post]');
      if (!btn) return;
      e.preventDefault();
      btn.disabled = true;
      try {
        await postWithJwt(btn.dataset.post);
        location.reload();
      } catch (err) {
        alert('요청 실패: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    });
</script>